<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>Sentient Memory Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --amber:#D8772B; --amber-700:#7A2A14; --teal:#1E6A6B;
      --ink:#0A0B0D; --ink-2:#0E1114;
      --gap:10px;               /* kart aralƒ±ƒüƒ± */
      --board-max: 520px;       /* masa√ºst√ºnde azami geni≈ülik */
      --ring: 0 0 0 3px rgba(216,119,43,.28);
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }

    body{
      display:flex; flex-direction:column; align-items:center; gap:1rem;
      min-height:100vh; padding:1rem; padding-bottom:130px; /* canlƒ± score kartƒ± i√ßin alan */
      color:#EDEFF2; background-color:var(--ink);
      background:
        url('images/bg.png') center/cover no-repeat fixed,
        radial-gradient(55% 40% at 50% 105%, rgba(216,119,43,.22), transparent 70%),
        linear-gradient(180deg, var(--ink) 0%, var(--ink) 100%);
    }

    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.18;
      background-image:
        radial-gradient(rgba(30,106,107,.25) 1px, transparent 1px),
        radial-gradient(rgba(216,119,43,.22) 1px, transparent 1px);
      background-size:160px 160px, 220px 220px;
      background-position:0 0, 80px 120px;
    }

    h1,h2{ text-align:center; color:var(--amber); }
    h1{ font-size:2rem; line-height:1.2; text-shadow:0 0 18px rgba(216,119,43,.35); }

    /* INTRO */
    #intro{
      position:fixed; inset:0; background:rgba(10,11,13,.86);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:1.2rem; text-align:center; padding:1.5rem;
      box-shadow:var(--ring); border-top:1px solid rgba(216,119,43,.2); border-bottom:1px solid rgba(30,106,107,.2);
      z-index:50;
    }
    #intro p{ max-width:520px; line-height:1.45; color:#dbe3ea; }
    #xname-input{
      padding:.6rem 1rem; border-radius:10px; border:1px solid rgba(216,119,43,.35);
      background:#0f1316; color:#fff; font-size:1rem; width:min(280px,80vw); box-shadow:var(--ring);
    }

    /* INFO */
    #game-info{ display:flex; gap:1rem; font-size:1.05rem; color:#dbe3ea; flex-wrap:wrap; justify-content:center; }

    /* BOARD: responsive ƒ±zgara */
    #board{
      width:min(95vw, var(--board-max));
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:var(--gap);
      margin-top:.5rem;
    }

    /* Kart: her zaman kare */
    .card{
      position:relative;
      width:100%;
      aspect-ratio:1/1;             /* kare tut */
      perspective:600px; cursor:pointer;
    }
    .card img{
      position:absolute; inset:0;
      width:100%; height:100%; border-radius:12px;
      backface-visibility:hidden; transition: transform .45s;
      border:2px solid rgba(30,106,107,.28);
      box-shadow:0 0 10px rgba(30,106,107,.16);
      object-fit:cover;
    }
    .card .front{ transform: rotateY(180deg); }
    .card .back { transform: rotateY(0deg); background:#12171b; }
    .card.flip .front{ transform: rotateY(0deg); }
    .card.flip .back { transform: rotateY(180deg); }
    .card.matched{ cursor:default; }
    .card.matched img{ border-color:rgba(216,119,43,.75); box-shadow:0 0 18px rgba(216,119,43,.45); }

    /* RESULT */
    #result{
      display:none; flex-direction:column; align-items:center; gap:.75rem;
      padding:1.2rem 1.4rem; border:2px solid var(--amber); border-radius:16px;
      box-shadow:0 0 16px rgba(216,119,43,.45), 0 0 24px rgba(30,106,107,.32) inset;
      background:linear-gradient(180deg, rgba(15,19,22,.92), rgba(10,11,13,.92));
      color:#eef3f7; z-index:10;
      max-width:min(92vw, 520px);
    }

    #buttons{ display:flex; gap:.8rem; flex-wrap:wrap; justify-content:center; }

    button, a.button{
      border:none; color:#0c0e0f; font-weight:800; cursor:pointer; text-decoration:none; letter-spacing:.2px;
      padding:.65rem 1.1rem; border-radius:12px;
      background:linear-gradient(90deg, var(--amber), var(--teal));
      box-shadow:0 6px 18px rgba(216,119,43,.35), 0 0 0 1px rgba(30,106,107,.25) inset;
    }
    .button-sm{ padding:.45rem .8rem; font-weight:700; font-size:.9rem; }
    button[disabled]{ opacity:.6; cursor:not-allowed; }
    button:not([disabled]):hover, a.button:hover{ filter:brightness(1.08); box-shadow:0 8px 22px rgba(216,119,43,.45); }
    button:active, a.button:active{ transform: translateY(1px); }

    /* HIDDEN SHARE CARD */
    #share-wrapper{ position:absolute; left:-10000px; top:-10000px; }
    .share-card{
      width:420px; height:240px; border-radius:16px;
      background: radial-gradient(70% 90% at 30% 20%, #13181c, #0a0b0d);
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.4rem;
      color:#fff; border:4px solid var(--amber); box-shadow:0 0 16px rgba(30,106,107,.5); overflow:hidden;
    }
    .share-avatar{ width:56px; height:56px; border-radius:50%; border:3px solid var(--amber); object-fit:cover; }
    .share-card h2{ margin-bottom:.1rem; font-size:1.5rem; color:var(--amber); }
    .share-card p{ font-size:1rem; color:#f3e9e2; }

    /* PLAYER BADGE */
    #player-badge{
      position:fixed; top:1rem; right:1rem; z-index:20;
      display:flex; align-items:center; gap:.6rem;
      padding:.5rem .7rem; border-radius:999px;
      background:linear-gradient(180deg,#14181c,#0b0d10);
      border:1px solid rgba(216,119,43,.35); box-shadow:var(--ring);
      display:none;
    }
    #player-badge img{ width:36px; height:36px; border-radius:50%; object-fit:cover; border:2px solid rgba(216,119,43,.6); }
    #player-badge span{ color:#e7edf3; font-weight:700; }

    /* LIVE SCORE CARD */
    #live-card-container{
      position:fixed; left:0; right:0;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      display:none; z-index:25;
      display:flex; justify-content:center; pointer-events:none;
    }
    #live-card{
      pointer-events:auto;
      width:min(360px, 92vw); border-radius:16px; padding:.75rem 1rem;
      background: radial-gradient(70% 90% at 30% 20%, #13181c, #0a0b0d);
      border:2px solid var(--amber);
      box-shadow:0 0 16px rgba(216,119,43,.35), 0 0 24px rgba(30,106,107,.25) inset;
      display:flex; align-items:center; gap:.8rem;
    }
    #live-card img{ width:44px; height:44px; border-radius:50%; object-fit:cover; border:2px solid rgba(216,119,43,.7); }
    #live-meta{ display:flex; flex-direction:column; line-height:1.25; }
    #live-name{ font-weight:800; color:var(--amber); }
    #live-stats{ color:#e7edf3; opacity:.95; font-size:.95rem; }
    #live-actions{ margin-left:auto; display:flex; gap:.5rem; }

    /* CREDITS */
    #credits{
      position:fixed; bottom:calc(70px + env(safe-area-inset-bottom, 0px)); right:1rem; max-width:60vw;
      font-size:.9rem; line-height:1.3; text-align:right; opacity:.6;
    }
    #credits a{ color:var(--amber); text-decoration:underline; }

    /* ------- LEADERBOARD ------- */
    #leaderboard{
      position:fixed; top:6rem; right:1rem; z-index:40;
      width:min(320px, 90vw); max-height:70vh; overflow:auto;
      padding:0.9rem 1rem; border-radius:16px;
      background: radial-gradient(70% 90% at 30% 20%, #13181c, #0a0b0d);
      border:2px solid var(--amber);
      box-shadow:0 0 16px rgba(216,119,43,.35), 0 0 24px rgba(30,106,107,.25) inset;
      display:none;
    }
    #lb-title{ font-weight:800; color:var(--amber); margin-bottom:.4rem; }
    #lb-list{ list-style:none; display:flex; flex-direction:column; gap:.35rem; }
    .lb-item{ display:flex; align-items:center; gap:.6rem; }
    .lb-rank{ width:1.6rem; text-align:right; font-weight:800; color:var(--amber); }
    .lb-avatar{ width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid rgba(216,119,43,.6); }
    .lb-handle{ font-weight:700; color:#e7edf3; }
    .lb-stats{ margin-left:auto; opacity:.9; font-size:.95rem; }

    /* ------- MOBIL UYUMLA≈ûTIRMALAR ------- */
    @media (max-width: 480px){
      :root{ --gap:8px; }
      h1{ font-size:1.6rem; }
      #board{ width:94vw; }
      #player-badge{ right:auto; left:.6rem; top:.6rem; }
      #game-info{ font-size:.95rem; }
      #result{ padding:1rem 1.1rem; }
      #leaderboard{ right:.6rem; left:.6rem; top:auto; bottom: calc(120px + env(safe-area-inset-bottom, 0px)); }
    }
    @media (max-width: 360px){
      #board{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
      #live-card img{ width:40px; height:40px; }
      #live-stats{ font-size:.9rem; }
    }
    @media (orientation: landscape) and (max-height: 420px){
      body{ padding-bottom:100px; }
      #live-card{ width:min(420px, 94vw); padding:.6rem .8rem; }
      #credits{ display:none; }
    }
  </style>
</head>

<body>
  <h1>Sentient Memory Match</h1>

  <div id="game-info">
    <span id="memorize-countdown"></span>
    <span id="play-countdown"></span>
    <span id="score-display"></span>
  </div>

  <div id="board"></div>

  <!-- RESULT -->
  <div id="result">
    <h2>Congratulations!</h2>
    <p id="result-message"></p>
    <div id="buttons">
      <a id="download-btn" class="button" href="#">Download Your Score Card</a>
      <a id="share-btn" class="button" target="_blank" href="#">Share on X</a>
      <button id="restart-btn" class="button">Restart</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <aside id="leaderboard">
    <div id="lb-title">üèÜ Leaderboard</div>
    <ol id="lb-list"></ol>
  </aside>

  <!-- INTRO OVERLAY -->
  <div id="intro">
    <h2>How to Play / Nasƒ±l Oynanƒ±r?</h2>
    <p><strong>EN:</strong> Memorize the positions of all cards in 15 seconds. Then the cards flip. Match as many pairs as you can in 20 seconds.</p>
    <p><strong>TR:</strong> 15 saniyede kartlarƒ±n yerlerini ezberleyin. Sonra kartlar kapanƒ±r. 20 saniyede m√ºmk√ºn olduƒüunca √ßok √ßifti e≈üle≈ütirin.</p>
    <input id="xname-input" type="text" inputmode="text" autocomplete="username" placeholder="@kullaniciadi (X username)" />
    <button id="start-btn" class="button">Start / Ba≈ülat</button>
  </div>

  <!-- PLAYER BADGE -->
  <div id="player-badge">
    <img id="profile-avatar" src="" alt="avatar" crossOrigin="anonymous" />
    <span id="profile-handle">@player</span>
  </div>

  <!-- LIVE SCORE CARD -->
  <div id="live-card-container">
    <div id="live-card">
      <img id="live-avatar" src="" alt="avatar" crossOrigin="anonymous" />
      <div id="live-meta">
        <div id="live-name">@player</div>
        <div id="live-stats">Matches: 0/8 ‚Ä¢ Time: 0s</div>
      </div>
      <div id="live-actions">
        <a id="live-download-btn" class="button button-sm" href="#">Download</a>
      </div>
    </div>
  </div>

  <!-- HIDDEN SHARE CARD TEMPLATE -->
  <div id="share-wrapper">
    <div class="share-card" id="share-card">
      <img id="sc-avatar" class="share-avatar" src="" alt="avatar" crossOrigin="anonymous" />
      <h2 id="sc-title">Sentient Memory Match</h2>
      <p id="sc-username">@player</p>
      <p id="sc-score">Score: 0/8</p>
      <p id="sc-time">Time left: 0s</p>
    </div>
  </div>

  <div id="credits">
    created by: <a href="https://twitter.com/cryptoayax" target="_blank">x:cryptoayax</a> ‚Ä¢ discord: cryptoayax
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    // CONFIG
    const FRONT_IMAGES = [
      "images/img1.png","images/img2.png","images/img3.png","images/img4.png",
      "images/img5.png","images/img6.png","images/img7.png","images/img8.png"
    ];
    const BACK_IMAGE = "images/back.png";
    const MEMORIZE_SECONDS = 15, PLAY_SECONDS = 20;

    // DOM refs
    const boardEl = document.getElementById("board"),
          memorizeCd = document.getElementById("memorize-countdown"),
          playCd = document.getElementById("play-countdown"),
          scoreDisplay = document.getElementById("score-display"),
          resultCard = document.getElementById("result"),
          resultMsg = document.getElementById("result-message"),
          downloadBtn = document.getElementById("download-btn"),
          shareBtn = document.getElementById("share-btn"),
          restartBtn = document.getElementById("restart-btn"),
          intro = document.getElementById("intro"),
          startBtn = document.getElementById("start-btn"),
          xnameInput = document.getElementById("xname-input"),
          playerBadge = document.getElementById("player-badge"),
          profileAvatar = document.getElementById("profile-avatar"),
          profileHandle = document.getElementById("profile-handle"),
          liveContainer = document.getElementById("live-card-container"),
          liveAvatar = document.getElementById("live-avatar"),
          liveName = document.getElementById("live-name"),
          liveStats = document.getElementById("live-stats"),
          liveDownloadBtn = document.getElementById("live-download-btn"),
          shareCard = document.getElementById("share-card"),
          scAvatar = document.getElementById("sc-avatar"),
          scUsername = document.getElementById("sc-username"),
          scScore = document.getElementById("sc-score"),
          scTime = document.getElementById("sc-time");

    // STATE
    let firstCard = null, lockBoard = false, matchedPairs = 0,
        playTimer, playTimeLeft = PLAY_SECONDS, xname = "player",
        isMemorizePhase = false, memorizeTimer, memorizeTimeLeft = MEMORIZE_SECONDS,
        avatarUrl = "";
    let playStartMs = 0; // <‚Äî s√ºre √∂l√ß√ºm√º i√ßin

    const sanitizeHandle = (v) => v.replace(/\s+/g,"").replace(/^@/,"");
    const resolveAvatar = (handle) => `https://unavatar.io/x/${encodeURIComponent(handle)}`;

    function setAllAvatars(url){
      profileAvatar.src = url; liveAvatar.src = url; scAvatar.src = url;
      const onerr = () => { profileAvatar.src = BACK_IMAGE; liveAvatar.src = BACK_IMAGE; scAvatar.src = BACK_IMAGE; };
      profileAvatar.onerror = onerr; liveAvatar.onerror = onerr; scAvatar.onerror = onerr;
    }

    // START
    startBtn.addEventListener("click", () => {
      const val = sanitizeHandle(xnameInput.value || "");
      if (!val) { alert("L√ºtfen X kullanƒ±cƒ± adƒ±nƒ±zƒ± girin (√∂rn. @sizinadiniz)."); return; }
      xname = val; avatarUrl = resolveAvatar(xname); setAllAvatars(avatarUrl);
      profileHandle.textContent = "@" + xname; liveName.textContent = "@" + xname; scUsername.textContent = "@" + xname;

      playerBadge.style.display = "flex";
      liveContainer.style.display = "flex";
      intro.style.display = "none";
      initGame();
    });

    restartBtn.addEventListener("click", () => {
      resultCard.style.display = "none";
      document.getElementById('leaderboard').style.display = 'none';
      boardEl.style.pointerEvents = "all";
      initGame();
    });

    // INIT
    function initGame(){
      clearInterval(memorizeTimer); clearInterval(playTimer);
      matchedPairs = 0; firstCard = null; lockBoard = false;
      memorizeTimeLeft = MEMORIZE_SECONDS; playTimeLeft = PLAY_SECONDS;
      createBoard();
      isMemorizePhase = true;
      boardEl.style.pointerEvents = 'none';
      updateScore(); updateLiveCard();
      startMemorizePhase();
      requestAnimationFrame(() => window.scrollTo({top:0, behavior:"smooth"}));
    }

    function createBoard(){
      const doubled = [...FRONT_IMAGES, ...FRONT_IMAGES];
      shuffle(doubled);
      boardEl.innerHTML = "";
      doubled.forEach(src => {
        const card = document.createElement("div");
        card.className = "card flip";
        card.innerHTML = `
          <img class="front" src="${src}" alt=""/>
          <img class="back" src="${BACK_IMAGE}" alt=""/>
        `;
        card.addEventListener("click", handleCard, {passive:true});
        boardEl.appendChild(card);
      });
      updateScore();
    }

    // Memorize phase
    function startMemorizePhase(){
      memorizeTimeLeft = MEMORIZE_SECONDS;
      memorizeCd.textContent = `Memorize: ${memorizeTimeLeft}s`;
      playCd.textContent = ""; updateLiveCard();
      memorizeTimer = setInterval(() => {
        memorizeTimeLeft--; memorizeCd.textContent = `Memorize: ${memorizeTimeLeft}s`; updateLiveCard();
        if (memorizeTimeLeft <= 0) {
          clearInterval(memorizeTimer);
          flipAllToBack(); isMemorizePhase = false; boardEl.style.pointerEvents = 'all';
          startPlayPhase();
        }
      }, 1000);
    }
    function flipAllToBack(){ document.querySelectorAll(".card").forEach(c => c.classList.remove("flip")); }

    // Play phase
    function startPlayPhase(){
      playStartMs = Date.now(); // <‚Äî √∂l√ß√ºm ba≈ülangƒ±cƒ±
      playTimeLeft = PLAY_SECONDS;
      playCd.textContent = `Time: ${playTimeLeft}s`; updateLiveCard();
      playTimer = setInterval(() => {
        playTimeLeft--; playCd.textContent = `Time: ${playTimeLeft}s`; updateLiveCard();
        if (playTimeLeft <= 0) { clearInterval(playTimer); endGame(); }
      }, 1000);
    }

    // Card click
    function handleCard(e){
      if (isMemorizePhase) return;
      const card = e.currentTarget;
      if (lockBoard || card === firstCard || card.classList.contains("matched")) return;
      card.classList.add("flip");
      if (!firstCard){ firstCard = card; return; }

      if (frontSrc(card) === frontSrc(firstCard)){
        card.classList.add("matched");
        firstCard.classList.add("matched");
        firstCard = null; matchedPairs++; updateScore(); updateLiveCard();
        if (matchedPairs === FRONT_IMAGES.length) endGame();
      }else{
        lockBoard = true;
        setTimeout(() => {
          card.classList.remove("flip");
          firstCard.classList.remove("flip");
          firstCard = null; lockBoard = false;
        }, 750);
      }
    }

    // End game
    async function endGame(){
      clearInterval(playTimer);
      boardEl.style.pointerEvents = "none";
      memorizeCd.textContent = ""; playCd.textContent = "";
      const msg = `@${xname} ‚Äî Score: ${matchedPairs}/${FRONT_IMAGES.length} ‚Ä¢ Time left: ${playTimeLeft}s`;
      resultMsg.textContent = msg;
      updateShareCardFields();
      resultCard.style.display = "flex";

      const tweetText = encodeURIComponent(`I just played Sentient Memory Match! My score: ${matchedPairs}/${FRONT_IMAGES.length}`);
      const tweetUrl = encodeURIComponent(window.location.href);
      shareBtn.href = `https://twitter.com/intent/tweet?text=${tweetText}&url=${tweetUrl}`;

      // ---- SCORE SUBMIT + LEADERBOARD ----
      try {
        const elapsed = Math.max(0, Date.now() - playStartMs); // 20sn oyun s√ºresi i√ßinde ge√ßen ger√ßek ms
        await submitScore(xname, matchedPairs, elapsed);
      } catch(e){ console.error('submitScore error', e); }

      try {
        const items = await fetchLeaderboard();
        renderLeaderboard(items);
        document.getElementById('leaderboard').style.display = 'block';
      } catch(e){ console.error('leaderboard error', e); }
    }

    // Live & Share helpers
    function updateScore(){ scoreDisplay.textContent = `Matches: ${matchedPairs}/${FRONT_IMAGES.length}`; }
    function currentTimeLeft(){ return isMemorizePhase ? memorizeTimeLeft : playTimeLeft; }
    function updateLiveCard(){
      liveStats.textContent = `Matches: ${matchedPairs}/${FRONT_IMAGES.length} ‚Ä¢ Time: ${currentTimeLeft()}s`;
      updateShareCardFields();
    }
    function updateShareCardFields(){
      scUsername.textContent = "@" + xname;
      scScore.textContent = `Score: ${matchedPairs}/${FRONT_IMAGES.length}`;
      scTime.textContent = `Time left: ${currentTimeLeft()}s`;
      if (avatarUrl) setAllAvatars(avatarUrl);
    }

    async function downloadCurrentScore(filename = "sentient-score.png"){
      updateShareCardFields();
      const canvas = await html2canvas(shareCard, {useCORS:true, backgroundColor:null});
      const link = document.createElement("a");
      link.download = filename; link.href = canvas.toDataURL("image/png");
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    downloadBtn.addEventListener("click", (e) => { e.preventDefault(); downloadCurrentScore(); });
    liveDownloadBtn.addEventListener("click", (e) => { e.preventDefault(); downloadCurrentScore(); });

    // ---- Leaderboard yardƒ±mcƒ±larƒ± ----
    function formatMs(ms){
      return (ms/1000).toFixed(2) + "s"; // saniye+salise
    }
    function avatarFor(handle){
      return `https://unavatar.io/x/${encodeURIComponent(handle)}`;
    }

    async function submitScore(handle, matched, timeMs){
      const res = await fetch('/api/submit-score', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ handle, matched, timeMs })
      });
      if (!res.ok) throw new Error('submit failed');
      return res.json();
    }

    async function fetchLeaderboard(){
      const res = await fetch('/api/leaderboard');
      if (!res.ok) throw new Error('leaderboard failed');
      const data = await res.json();
      return data.items || [];
    }

    function renderLeaderboard(items){
      const list = document.getElementById('lb-list');
      list.innerHTML = '';
      items.forEach((it, idx) => {
        const li = document.createElement('li');
        li.className = 'lb-item';
        const av = avatarFor(it.handle);
        li.innerHTML = `
          <span class="lb-rank">${idx+1}.</span>
          <img class="lb-avatar" src="${av}" onerror="this.style.visibility='hidden'"/>
          <span class="lb-handle">@${it.handle}</span>
          <span class="lb-stats">${it.matched}/8 ‚Ä¢ ${formatMs(it.timeMs)}</span>
        `;
        list.appendChild(li);
      });
    }

    // Utils
    const frontSrc = card => card.querySelector('.front').src;
    function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  </script>
</body>
</html>
